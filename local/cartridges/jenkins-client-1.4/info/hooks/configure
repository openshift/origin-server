#!/bin/bash

# Creates a jenkins client instance

# Exit on any errors
set -e

function print_help {
    echo "Usage: $0 app-name namespace uuid"

    echo "$0 $@" | logger -p local0.notice -t stickshift_jenkins_client_configure
    exit 1
}

while getopts 'd' OPTION
do
    case $OPTION in
        d) set -x
        ;;
        ?) print_help
        ;;
    esac
done


[ $# -eq 3 ] || print_help

source "/etc/stickshift/stickshift-node.conf"
source ${CARTRIDGE_BASE_PATH}/abstract/info/lib/util

app_type="jenkins-client-1.4"
setup_embedded_configure "$1" $2 $3

#
# Create the core of the application
#

if ! [ -f "$APP_HOME/.env/JENKINS_URL" ]
then
    client_error "Jenkins server does not exist!  Please create with rhc app create -t jenkins-1.4"
    exit 151
fi
if [ -f "$APP_HOME/.env/OPENSHIFT_CI_TYPE" ]
then
    client_error "Jenkins client already embedded in $application"
    exit 152
fi

#
# Setup Environment Variables
#
echo "export OPENSHIFT_CI_TYPE='jenkins-1.4'" > $APP_HOME/.env/OPENSHIFT_CI_TYPE
echo "export PATH=\$PATH:${CART_INFO_DIR}/bin/" > $APP_HOME/.env/PATH_JENKINS_CLIENT

. $APP_HOME/.env/OPENSHIFT_HOMEDIR
. $APP_HOME/.env/OPENSHIFT_GEAR_NAME
. $APP_HOME/.env/OPENSHIFT_GEAR_UUID
. $APP_HOME/.env/OPENSHIFT_GEAR_TYPE
. $APP_HOME/.env/JENKINS_URL
. $APP_HOME/.env/JENKINS_USERNAME
. $APP_HOME/.env/JENKINS_PASSWORD

JENKINS_DNS_NAME=${JENKINS_URL:8} #remove https://

mkdir -p "$OPENSHIFT_HOMEDIR/jenkins-client-1.4/"

if ! $(/usr/bin/wget --no-check-certificate -q https://${JENKINS_USERNAME}:${JENKINS_PASSWORD}@${JENKINS_DNS_NAME}jnlpJars/jenkins-cli.jar -O "$OPENSHIFT_HOMEDIR/jenkins-client-1.4/jenkins-cli.jar")
then
   client_error "Error contacting Jenkins server."
   client_error "Could not download ${JENKINS_URL}jnlpJars/jenkins-cli.jar"
   exit 157
fi

echo $JENKINS_PASSWORD > $OPENSHIFT_HOMEDIR/jenkins-client-1.4/.password

# Maybe allow cartridges to create their own jenkins job
if [ -f "${CARTRIDGE_BASE_PATH}/${OPENSHIFT_GEAR_TYPE}/info/configuration/jenkins_job_template.xml" ]
then
    JOB_XML="${CARTRIDGE_BASE_PATH}/${OPENSHIFT_GEAR_TYPE}/info/configuration/jenkins_job_template.xml"
else
    JOB_XML="$CART_INFO_DIR/configuration/jenkins_job_template.xml"
fi

JOB_NAME=${OPENSHIFT_GEAR_NAME}-build

if out=$(${CART_INFO_DIR}/bin/jenkins_create_job "${namespace}" "${CLOUD_DOMAIN}" "$JOB_XML" 2>&1)
then
    # Embedding success
    client_result ""
else
    if enable_out=$(run_as_user "${CART_INFO_DIR}/bin/jenkins_job_action enable" 2>&1)
    then
        client_result ""
        client_result "Associated with existing job '${JOB_NAME}' in Jenkins server."
        client_result "If this was not intended you can remove the jenkins client, remove or rename "
        client_result "the existing job, and re-add the jenkins client to get a new job created."
        bldr_url="${JENKINS_DNS_NAME}computer/${OPENSHIFT_GEAR_NAME}bldr/"
        status_code=`curl -s -w %{http_code} --output /dev/null --insecure https://${JENKINS_USERNAME}:${JENKINS_PASSWORD}@$bldr_url`
        if [ "$status_code" == "200" ]
        then
            client_result "In addition we found an existing builder which you might also want"
            client_result "to delete: http://${bldr_url}"
        fi
        client_result ""
    else
        # An error occurred enabling existing job
        client_error ""
        client_error "Could not add job '${JOB_NAME}' in Jenkins server:"
        client_error "   $out"
        client_error "You'll need to correct this error before attempting to embed the Jenkins client again."
        exit 1
    fi
fi
client_result "Job URL: ${JENKINS_URL}job/${JOB_NAME}/"
client_result ""
client_result "Jenkins client 1.4 has been added to: $OPENSHIFT_GEAR_NAME"

set_app_info "Job URL: ${JENKINS_URL}job/${JOB_NAME}/"
