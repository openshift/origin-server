%h1.invisible Configure New Application
= app_wizard_steps_create 1
= breadcrumb_for_create_application(@application_type.persisted? ? "Based on '#{@application_type.display_name}'" : "From scratch")
= flashes

:css
  #new_application.form-horizontal .control-group { margin-bottom: 14px; }
  #new_application.form-horizontal .controls { margin-left: 140px; }
  #new_application.form-horizontal input.expand { width: auto; max-width: -moz-available; }
  #new_application.form-horizontal input.narrow { width: 140px; }
  #new_application.form-horizontal .controls > h3 { margin-top: 5px; margin-bottom: 0; color: #FAFBFC; }
  #new_application.form-horizontal .controls > h3 > small { margin-left: 10px; vertical-align: middle; display: inline-block; }
  #new_application.form-horizontal .controls > h3 > select { margin-top: -5px; }
  #new_application.form-horizontal .control-label { margin-left: 15px; width: 120px; text-align: left; color: #949494; }
  #new_application.form-horizontal .help-block { color: #949494; max-width: 500px; -moz-transition: 0.2s; overflow: hidden; text-overflow: ellipsis; }
  #new_application.form-horizontal .form-actions { padding-left: 140px; }
  #new_application.collapse-help .help-block { white-space: nowrap; opacity: 0.5; margin-top: 0; }
  #new_application.collapse-help .help-block:hover { opacity: 1; cursor: pointer; }
  @media (max-width: 767px) {
    #new_application.form-horizontal .control-label { margin-left: 0; }
    #new_application.form-horizontal .controls { margin-left: 0; }
    #new_application.form-horizontal .help-block { max-width: inherit; white-space: normal; }
    #new_application.form-horizontal .controls input { display: inline; }
    #new_application.form-horizontal .controls > h3 { display: inline-block; margin-top: 0; }
    #new_application.form-horizontal .form-actions { padding-left: 10px; }
  }

- advanced_path = application_type_path(@application_type.id, @application_type.to_params.merge(:advanced => true))

= semantic_form_for @application, :url => applications_path, :html => {:class => "form-horizontal #{@domain.persisted? ? 'collapse-help' : ''}"} do |f|
  = hidden_field_tag :advanced, @advanced
  - if @application_type.persisted?
    = f.hidden_field :application_type, :value => @application_type.id
  - else
    - Array(@application_type.cartridges).each do |c|
      = hidden_field_tag 'application_type[cartridges][]', c
    = hidden_field_tag 'application_type[initial_git_url]', @application_type.initial_git_url
    -#= hidden_field_tag 'application_type[initial_git_branch]', @application_type.initial_git_branch

  = f.semantic_errors :name, :domain_name, :node_profile, :cartridges, :cartridge, :initial_git_url, :initial_git_branch, :scale

  - if @application_type.tags.include? :in_development
    .alert This template is development only and not accessible in production

  %fieldset.inputs
    .control-group.control-group-important
      %h3.control-label Based On
      .controls.first
        %h3 
          #{@application_type.display_name} #{@application_type.source.to_s.humanize}

          %small.pull-right.label-tags= application_type_tags(@application_type.tags)

      .controls
        - if @application_type.persisted?
          - if @application_type.description.html_safe?
            = @application_type.description
          - else
            %p.help-block= @application_type.description

          - if @application_type.website
            %p.help-block= link_to @application_type.website, @application_type.website
          - if @application_type.learn_more_url
            %p.help-block= link_to "Learn more", @application_type.learn_more_url

        - else
          %p.help-block 
            This application is based on a link.
            -# If you want others to see this application, #{link_to "create a quickstart in our community", create_quickstart_url}.
          %p.help-block= link_to "Share this link", application_type_url(@application_type.id, @application_type.to_params)

  %fieldset.inputs
    - errors = @application.errors.full_messages.present?
    -# This is implemented custom here rather than integrating into Formtastic because of its specific nature
    .control-group.control-group-important{:data => errors ? {:"server-error" => 'true'} : {}}
      %h3.control-label Public URL
      .controls.first
        = render :partial => 'applications/name', :locals => {:form => f, :application => @application}
      .controls
        %p.help-block
          OpenShift will automatically register this domain name for your application.  You can add
          your own domain name later.

    .control-group.control-group-important
      %h3.control-label Source Code
      .controls.first
        - if @advanced
          = f.text_field :initial_git_url, :class => 'expand', :placeholder => 'URL to a Git repository'
          -#= f.text_field :initial_git_branch, :class => 'narrow', :placeholder => 'Git branch (optional)'
        - else
          %h3
            - if @application_type.initial_git_url
              #{link_to @application_type.initial_git_url, @application_type.initial_git_url, :target => "_blank"}
              -# if @application_type.initial_git_branch
                (branch '#{@application_type.initial_git_branch}')
            - else
              Default 
            %small= link_to "Change", advanced_path

      .controls
        %p.help-block 
          - if @application_type.initial_git_url
            Your application will start with a copy of the code and configuration provided in 
            this Git repository.
          - else
            We'll create a Git code repository in the cloud, and populate it with a set of 
            reasonable defaults. 

    .control-group.control-group-important
      %h3.control-label Gears
      .controls.first
        - gear_sizes = @capabilities.gear_sizes
        - if gear_sizes.length > 1
          - if @advanced
            = f.select :gear_profile, gear_sizes.map{ |size| [size.to_s.titleize, size]}
          - else
            %h3
              = gear_sizes.first.to_s.titleize
              %small= link_to 'Change', advanced_path
            = f.hidden_field :gear_profile

        - else
          %h3= gear_sizes.first.to_s.titleize
          = f.hidden_field :gear_profile

      .controls
        %p.help-block
          Gears are the application containers running your code. For most applications,
          the '#{gear_sizes.first.to_s}' gear size provides plenty of resources.

          - if gear_sizes.length > 1
            If you require more resources, select a larger gear size here.

    .control-group.control-group-important
      %h3.control-label Cartridges
      .controls.first
        - if @cartridges.present?
          %h3
            = map_to_sentence(@cartridges) do |(name, carts)|
              - if carts.length > 1
                = select_tag 'application[cartridges][]', options_for_select(carts.sort.map{ |c| [c.display_name, c.name] }), :title => "Choose a cartridge that matches '#{name}'"
              - elsif carts.length == 1
                = hidden_field_tag 'application[cartridges][]', [carts.first.name]
                = carts.first.display_name
              - else
                %span.text-warning #{name}
        - else
          %h3
            %span.text-warning{:title => 'All applications require at least a web cartridge'} None

      .controls
        %p.help-block
          Applications are composed of cartridges - each of which exposes a service or 
          capability to your code.  All applications must have a web cartridge.

    .control-group.control-group-important
      %h3.control-label Scaling
      .controls.first
        - can_scale = can_scale_application_type(@application_type, @capabilities)
        - scale_reason = cannot_scale_title(@application_type, @capabilities)
        - if can_scale
          - if @advanced
            = f.select :scale, scale_options
          - else
            %h3
              = scale_options[@application.scale? ? 1 : 0][0]
              %small= link_to 'Change', advanced_path
        - else
          %h3
            %span.text-warning{:title => scale_reason}= scale_options[0][0]

      .controls
        %p.help-block
          OpenShift automatically routes web requests to your web gear.

          - if can_scale
            If you allow your application to scale, we'll set up a load balancer and
            allocate more gears to handle traffic as you need it.

          - else
            %span.text-warning= scale_reason

    .control-group
      .controls
        - if @application_type.template
          %p.text-warning
            After creation, check the repository README for any manual configuration 
            required to secure this application.

          %p
            %em Note: It may take up to a minute to deploy your application

  = f.buttons do
    = link_to "Back", application_types_path, :class => 'btn'
    = f.commit_button :button_html => { :name => 'submit', :disabled => @disabled } 
    = f.loading

- if @domain.persisted?
  - content_for :javascripts do
    :javascript
      jQuery('.help-block').click(function() {
        $("#new_application.collapse-help").removeClass('collapse-help');
      });
