#!/bin/bash
set -e
set -x

function marker_present() {
  if [ -f "${OPENSHIFT_REPO_DIR}/.openshift/markers/$1" ]; then
    return 0
  else
    return 1
  fi
}

#CONFIG_DIR="$CARTRIDGE_BASE_PATH/jbossews-2.0/info/configuration"
#OPENSHIFT_MAVEN_MIRROR="$CONFIG_DIR/settings.base.xml"
#if `echo $OPENSHIFT_GEAR_DNS | egrep -qe "\.rhcloud\.com"`
#then 
  #OPENSHIFT_MAVEN_MIRROR="$CONFIG_DIR/settings.rhcloud.xml"
#fi



#SKIP_MAVEN_BUILD=false
#if git show master:.openshift/markers/skip_maven_build > /dev/null 2>&1
#then
#    SKIP_MAVEN_BUILD=true
#fi

if [ ! -f ${OPENSHIFT_REPO_DIR}pom.xml ]; then
  echo "Skipping Maven build due to absence of pom.xml"
  exit 0
fi

if marker_present "force_clean_build"; then
  echo "force_clean_build marker found; removing Maven dependencies."
  rm -rf ${OPENSHIFT_HOMEDIR}.m2/* ${OPENSHIFT_HOMEDIR}.m2/.[^.]*
fi

if marker_present "java6"; then
  echo "java6 marker found; switching JAVA_HOME to JDK 1.6"
  export JAVA_HOME=/etc/alternatives/java_sdk_1.6.0
  export PATH=$JAVA_HOME/bin:$PATH
fi

# Calculate build heap size
max_memory_bytes=`oo-cgroup-read memory.limit_in_bytes`
max_memory_mb=`expr $max_memory_bytes / 1048576`
MAVEN_JVM_HEAP_RATIO=0.75
max_heap=$( echo "$max_memory_mb * $MAVEN_JVM_HEAP_RATIO" | bc | awk '{print int($1+0.5)}')
OPENSHIFT_MAVEN_XMX="-Xmx${max_heap}m"

export MAVEN_OPTS="$OPENSHIFT_MAVEN_XMX"

pushd ${OPENSHIFT_REPO_DIR} > /dev/null

if [ -z "$MAVEN_OPTS" ]; then
  export MAVEN_OPTS="$OPENSHIFT_MAVEN_XMX"
fi

export MAVEN_ARGS="clean package -Popenshift -DskipTests"

if [ -n "$OPENSHIFT_MAVEN_MIRROR" ]; then
    echo "Using Maven mirror $OPENSHIFT_MAVEN_MIRROR"
    mvn --global-settings $OPENSHIFT_MAVEN_MIRROR --version
    MVN_CMD="mvn --global-settings $OPENSHIFT_MAVEN_MIRROR $MAVEN_ARGS"
else
    mvn --version
    MVN_CMD="mvn $MAVEN_ARGS"
fi

echo "Found pom.xml... attempting to build with '$MVN_CMD'"

#$MVN_CMD

popd > /dev/null
