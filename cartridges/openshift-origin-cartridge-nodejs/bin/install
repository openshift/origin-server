#!/bin/bash
#set -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH
source "${OPENSHIFT_NODEJS_DIR}/lib/util"
source "${OPENSHIFT_NODEJS_DIR}/lib/nodejs_context"

case "$1" in
  -v|--version)
    OPENSHIFT_NODEJS_VERSION="$2"
esac

ln -s ${OPENSHIFT_DEPENDENCIES_DIR}nodejs/node_modules ${OPENSHIFT_HOMEDIR}.node_modules

## npm link
pushd $OPENSHIFT_NODEJS_DIR > /dev/null
  npmgl=$OPENSHIFT_NODEJS_DIR/versions/$OPENSHIFT_NODEJS_VERSION/configuration/npm_global_module_list
  module_list=$(comm -12 <(perl -ne 'print if /^\s*[^#\s]/' "$npmgl" | sort ) <(nodejs_context "npm ls -g 2> /dev/null" | grep '@' | awk -F'[ @]' '{print $2}' | sort ) | tr '\n' ' ')
  nodejs_context "npm link $module_list >/dev/null 2>&1"
popd > /dev/null

# npm keeps per-user config in ~/.npmrc and cache in ~/.npm/  and
# node-gyp (add-on build tool) uses ~/.node-gyp
# Create files/directories, change ownership and SELinux file security context.
touch "$OPENSHIFT_HOMEDIR"/.npmrc
mkdir "$OPENSHIFT_HOMEDIR"/.node-gyp
chown `id -u $OPENSHIFT_GEAR_UUID` -R "$OPENSHIFT_HOMEDIR"/.npmrc "$OPENSHIFT_HOMEDIR"/.node-gyp
nodejs_context "npm config set tmp $OPENSHIFT_TMP_DIR"

echo "$OPENSHIFT_NODEJS_VERSION" > $OPENSHIFT_NODEJS_DIR/env/OPENSHIFT_NODEJS_VERSION
update-configuration $OPENSHIFT_NODEJS_VERSION
